// #include <boost/math/distributions/chi_squared.hpp>
#include <iostream>
#include "../framework/est.h"

using namespace std;
// using namespace boost;



void sim_strategy(Params* params, vector<double> l, vector<tuple<int,int,int>> strategy, double sigma){
    cout<<"cost_model = "<<params->cost_model<<endl;
    int dim = int(l.size());
    BKZJSim* sim = new BKZJSim(params,dim);
    COST* cost = new COST(params);
    double Gcum = 0., Bcum = 0., cum_pr = 0., rem_pr = 1.;
    for(int i = 0; i<int(strategy.size()); i++){
        int beta = get<0>(strategy[i]), jump = get<1>(strategy[i]), tours = get<2>(strategy[i]);
        for(int t = 0; t< tours; t++){
            sim -> simulate(l,l,beta,jump,1);
            int beta_ = get_beta_(params, beta, jump, dim);
            double slope = get_current_slope(l,0,dim);
            boost::math::chi_squared chisquare(beta_);
            double pr = boost::math::cdf(chisquare,pow(2,2.*l[dim-beta_]));
            pair<double,double> G = cost->bkz_cost(dim,beta,jump,params->cost_model);
            printf("Strategy (%d,%d,%d), slope = %lf, sim-cost = %3.7f sec\n", beta,jump,t+1,slope, pow(2,G.first));
            Gcum = log2(pow(2,Gcum)+pow(2,G.first)*rem_pr*pr);
            Bcum = max(Bcum, G.second);

            cum_pr += rem_pr * pr;
            rem_pr = 1. - cum_pr;
        } 
    }

    // print_vector(l,0,dim);
    for(int i = 0; i < dim; i++){
        l[i] -= log2(sigma);
    }

    tuple<double,int,double,double> dsvp_t_ = dsvp_predict(l, 0., cost, params->cost_model, params->progressive_sieve, params->worst_case);

    int dsvp = get<1>(dsvp_t_);
    // int f = default_dim4free_fun(dsvp);
    int f = get_f_for_pump(params,dsvp);
    // int f = dims4free(dsvp);
    printf("pump-{%d,%d,%d}, sim-pump cost = %3.7f sec\n",  dim - dsvp, dsvp, f, pow(2, get<2>(dsvp_t_)));  
    Gcum = log2(pow(2,Gcum)+pow(2,get<2>(dsvp_t_)));
    Bcum = max(Bcum, get<3>(dsvp_t_));
    cout<<"Gcum = "<<Gcum<<", Bcum = "<<Bcum<<endl;

    cout<<"============================="<<endl;
}


//Simulate the stratey from original lwe instance 
void test_lwechal_from_original_instance(Params* params, int n, double alpha, vector<tuple<int,int,int>> strategy){

   
    LWEchal* lwechal = gen_lwechal_instance(n, alpha);
    int dim = lwechal->dim;
    FP_NR<FT> dvol = lwechal->dvol;
    vector<double> l = lwechal->log_rr, l_;
    double  sigma = lwechal->alpha * lwechal->q;
    // printf("No sigma normalization,");
    // sim_strategy(l, strategy,sigma);


    printf("After a sigma normalization,");
    for(int i = 0; i < dim; i++){
        l[i] -=  log2(sigma);
    }
    double slope = get_current_slope(l,0,dim);
    printf("slope = %f\n", slope);
    
    sim_strategy(params, l, strategy,1.);

    // throw "";
}


//Simulate the stratey from gsa-gs-lengths and original lwe instance 
void test_lwechal_from_gsa(Params* params, int dim, double dvol, vector<tuple<int,int,int>> strategy){
    printf("Generate gs-lengths by GSA assumption...\n");
    vector<double>  l = gen_simulated_gso(dim, dvol);
    double slope = get_current_slope(l,0,dim);
    cout<<"Slope of gs-lengths generated by GSA assumption: "<<slope<<endl;

    sim_strategy(params, l, strategy, 1.);
}


int main(){

    // int n = 40;
    // double alpha = 0.035;
    // vector<tuple<int,int,int>> strategy = {{83, 8, 1}, {93, 8, 1}, {108, 8, 1}, {117, 8, 1}, {119, 4, 1}, {133, 4, 1}};
    // // for(int i = 10; i < 50; i++)
    // //     strategy.insert(strategy.end(),{i,1,1});
    // test_lwechal_from_original_instance(params, n, alpha, strategy);



    Params* params = new Params;
    params->cost_model = 1;
    params->theo_pnjbkz_d4f = 2;
    params->theo_pump_d4f = 2;
    params->worst_case = false;
    printf("============= Kyber-I\n");
    //eta1 = 3, eta2 = 2
    int dim = 1004;
    double dvol = 3882.6780896;
    vector<tuple<int,int,int>>  strategy = {{ 50,  1,  1},{ 51,  1,  1},{ 52,  1,  1},{ 53,  1,  1},{ 54,  1,  1},{ 55,  1,  1},{ 56,  1,  1},{ 57,  1,  1},{ 58,  1,  1},{ 59,  1,  1},{ 60,  1,  1},{ 61,  1,  1},{ 62,  1,  1},{ 63,  1,  1},{ 64,  1,  1},{ 65,  1,  1},{ 66,  1,  1},{ 67,  1,  1},{ 68,  1,  1},{ 69,  1,  1},{ 70,  1,  1},{ 71,  1,  1},{ 72,  1,  1},{ 73,  1,  1},{ 74,  1,  1},{ 75,  1,  1},{ 76,  1,  1},{ 77,  1,  1},{ 80,  1,  5},{ 81,  8,  5},{ 81,  7,  5},{ 81,  4,  1},{ 82,  8,  5},{ 82,  7,  5},{ 83,  8,  5},{ 83,  7,  5},{ 83,  4,  1},{ 84,  8,  5},{ 84,  7,  5},{ 85,  8,  5},{ 85,  7,  4},{ 86,  8,  4},{ 87,  8,  5},{ 87,  7,  1},{ 87,  4,  5},{ 88,  4,  4},{ 89,  4,  5},{ 90,  4,  4},{ 91,  4,  4},{ 92,  4,  2},{ 93,  4,  2},{ 94,  4,  2},{ 95,  4,  2},{ 96,  4,  2},{ 97,  4,  2},{ 98,  4,  1},{100,  4,  4},{101,  4,  1},{102,  4,  2},{103,  4,  2},{104,  4,  1},{105,  4,  2},{106,  4,  1},{107,  4,  2},{108,  4,  2},{109,  4,  1},{110,  4,  1},{111,  4,  2},{112,  4,  1},{114,  4,  3},{115,  4,  2},{116,  4,  1},{117,  4,  1},{118,  4,  2},{119,  4,  1},{120,  4,  1},{121,  4,  1},{122,  4,  2},{123,  4,  1},{124,  4,  1},{125,  4,  1},{127,  4,  1},{128,  4,  3},{129,  4,  1},{130,  4,  1},{131,  4,  1},{132,  4,  1},{133,  4,  1},{134,  4,  1},{135,  4,  1},{136,  4,  1},{137,  4,  2},{138,  4,  1},{141,  4,  3},{142,  4,  1},{143,  4,  1},{144,  4,  1},{145,  4,  1},{146,  4,  1},{147,  4,  1},{148,  4,  1},{149,  4,  1},{150,  4,  1},{150,  2,  2},{151,  2,  1},{154,  2,  2},{155,  2,  1},{156,  2,  1},{157,  2,  1},{158,  2,  1},{162,  4,  1},{164,  4,  1},{165,  4,  1},{167,  4,  1},{169,  4,  1},{170,  4,  1},{171,  4,  1},{172,  4,  1},{173,  4,  1},{175,  4,  1},{176,  4,  1},{178,  4,  1},{179,  4,  1},{181,  4,  1},{183,  4,  1},{184,  4,  1},{185,  4,  1},{186,  4,  1},{188,  4,  1},{189,  4,  1},{191,  4,  1},{194,  4,  1},{195,  4,  1},{197,  4,  1},{198,  4,  1},{199,  4,  1},{201,  4,  1},{203,  4,  1},{205,  4,  1},{207,  4,  1},{209,  4,  1},{211,  4,  1},{212,  4,  1},{214,  4,  1},{216,  4,  1},{218,  4,  1},{221,  4,  1},{221,  2,  2},{223,  2,  1},{228,  4,  1},{230,  4,  1},{234,  4,  1},{236,  4,  1},{236,  2,  1},{237,  2,  1},{243,  4,  1},{245,  4,  1},{247,  2,  2},{250,  2,  1},{252,  2,  1},{258,  4,  1},{262,  4,  1},{262,  2,  1},{264,  2,  1},{267,  2,  1},{274,  4,  1},{276,  4,  1},{276,  2,  1},{278,  2,  1},{281,  2,  1},{289,  4,  1},{289,  2,  1},{291,  2,  1},{294,  2,  1},{298,  2,  1},{302,  2,  1},{305,  2,  1},{309,  2,  1},{314,  2,  1},{317,  2,  1},{320,  2,  1},{324,  2,  1},{328,  2,  1},{333,  2,  1},{336,  2,  1},{340,  2,  1},{345,  2,  1},{350,  2,  1},{354,  2,  1},{359,  2,  1},{364,  2,  1},{368,  2,  1},{374,  2,  1},{380,  2,  1},{385,  2,  1},{390,  2,  1},{395,  2,  1}};
    test_lwechal_from_gsa(params, dim, dvol, strategy);

    // Kyber-II(Kyber-768) round-3 parameters
    printf("============= Kyber-II\n");
    dim =  1467;
    dvol =  5661.0782118;
    strategy = {{ 50,  1,  1},{ 51,  1,  1},{ 52,  1,  1},{ 53,  1,  1},{ 54,  1,  1},{ 55,  1,  1},{ 56,  1,  1},{ 57,  1,  1},{ 58,  1,  1},{ 59,  1,  1},{ 60,  1,  1},{ 61,  1,  1},{ 62,  1,  1},{ 63,  1,  1},{ 64,  1,  1},{ 65,  1,  1},{ 66,  1,  1},{ 67,  1,  1},{ 68,  1,  1},{ 69,  1,  1},{ 70,  1,  1},{ 71,  1,  1},{ 72,  1,  1},{ 73,  1,  1},{ 74,  1,  1},{ 75,  1,  1},{ 76,  1,  1},{ 77,  1,  1},{ 78,  1,  1},{ 79,  1,  1},{ 80,  1,  1},{ 81,  1,  1},{ 82,  1,  1},{ 83,  1,  1},{ 84,  1,  1},{ 85,  1,  1},{ 86,  1,  1},{ 87,  1,  1},{ 88,  1,  1},{ 89,  1,  1},{ 90,  1,  1},{ 91,  1,  1},{ 92,  1,  1},{ 93,  1,  1},{ 94,  1,  1},{ 95,  1,  1},{ 96,  1,  1},{ 97,  1,  1},{ 98,  1,  1},{ 99,  1,  1},{100,  1,  1},{101,  1,  1},{102,  1,  1},{103,  1,  1},{104,  1,  1},{105,  1,  1},{106,  1,  1},{107,  1,  1},{108,  1,  1},{109,  1,  1},{110,  1,  1},{111,  1,  1},{112,  1,  1},{113,  1,  1},{114,  1,  1},{115,  1,  1},{116,  1,  1},{117,  1,  1},{118,  1,  1},{119,  1,  1},{120,  1,  1},{121,  1,  1},{122,  1,  1},{123,  1,  1},{124,  1,  1},{125,  1,  1},{126,  1,  1},{127,  1,  1},{128,  1,  1},{129,  1,  1},{130,  1,  1},{131,  1,  1},{132,  1,  1},{133,  1,  1},{134,  1,  1},{135,  1,  1},{136,  1,  1},{137,  1,  1},{138,  1,  1},{139,  1,  1},{140,  1,  1},{141,  1,  1},{142,  1,  1},{143,  1,  1},{144,  1,  1},{145,  1,  1},{146,  1,  1},{147,  1,  1},{148,  1,  1},{149,  1,  1},{150,  1,  1},{151,  1,  1},{152,  1,  1},{153,  1,  1},{154,  1,  1},{155,  1,  1},{156,  1,  1},{157,  1,  1},{158,  1,  1},{159,  1,  1},{160,  1,  1},{161,  1,  1},{162,  1,  1},{163,  1,  1},{164,  1,  1},{165,  1,  1},{166,  1,  1},{167,  1,  1},{168,  1,  1},{169,  1,  1},{170,  1,  1},{171,  1,  1},{172,  1,  1},{173,  1,  1},{174,  1,  1},{175,  1,  1},{176,  1,  1},{177,  1,  1},{178,  1,  1},{179,  1,  1},{180,  1,  1},{181,  1,  1},{182,  1,  1},{183,  1,  1},{184,  1,  1},{185,  1,  1},{186,  1,  1},{187,  1,  1},{188,  1,  1},{189,  1,  1},{190,  1,  1},{191,  1,  1},{192,  1,  1},{193,  1,  1},{194,  1,  1},{195,  1,  1},{196,  1,  1},{197,  1,  1},{198,  1,  1},{199,  1,  1},{200,  1,  1},{201,  1,  1},{202,  1,  1},{203,  1,  1},{204,  1,  1},{205,  1,  1},{206,  1,  1},{207,  1,  1},{208,  1,  1},{209,  1,  1},{210,  1,  1},{211,  1,  1},{212,  1,  1},{213,  1,  1},{214,  1,  1},{215,  1,  1},{216,  1,  1},{217,  1,  1},{218,  1,  1},{219,  1,  1},{220,  1,  1},{221,  1,  1},{222,  1,  1},{223,  1,  1},{224,  1,  1},{225,  1,  1},{226,  1,  1},{227,  1,  1},{228,  1,  1},{229,  1,  1},{230,  1,  1},{231,  1,  1},{232,  1,  1},{233,  1,  1},{234,  1,  1},{235,  1,  1},{236,  1,  1},{237,  1,  1},{238,  1,  1},{239,  1,  1},{240,  1,  1},{241,  1,  1},{242,  1,  1},{243,  1,  1},{244,  1,  1},{245,  1,  1},{246,  1,  1},{247,  1,  1},{248,  1,  1},{249,  1,  1},{250,  1,  1},{251,  1,  1},{252,  1,  1},{253,  1,  1},{254,  1,  1},{255,  1,  1},{256,  1,  1},{257,  1,  1},{258,  1,  1},{259,  1,  1},{260,  1,  1},{261,  1,  1},{262,  1,  1},{263,  1,  1},{264,  1,  1},{265,  1,  1},{266,  1,  1},{267,  1,  1},{268,  1,  1},{269,  1,  1},{270,  1,  1},{271,  1,  1},{272,  1,  1},{273,  1,  1},{274,  1,  1},{275,  1,  1},{276,  1,  1},{277,  1,  1},{278,  1,  1},{279,  1,  1},{280,  1,  1},{281,  1,  1},{282,  1,  1},{283,  1,  1},{284,  1,  1},{285,  1,  1},{286,  1,  1},{287,  1,  1},{288,  1,  1},{289,  1,  1},{290,  1,  1},{291,  1,  1},{292,  1,  1},{293,  1,  1},{294,  1,  1},{295,  1,  1},{296,  1,  1},{297,  1,  1},{298,  1,  1},{299,  1,  1},{300,  1,  1},{301,  1,  1},{302,  1,  1},{303,  1,  1},{304,  1,  1},{305,  1,  1},{306,  1,  1},{307,  1,  1},{308,  1,  1},{309,  1,  1},{310,  1,  1},{311,  1,  1},{312,  1,  1},{313,  1,  1},{314,  1,  1},{315,  1,  1},{316,  1,  1},{317,  1,  1},{318,  1,  1},{319,  1,  1},{320,  1,  1},{321,  1,  1},{322,  1,  1},{323,  1,  1},{324,  1,  1},{325,  1,  1},{326,  1,  1},{327,  1,  1},{328,  1,  1},{329,  1,  1},{330,  1,  1},{331,  1,  1},{332,  1,  1},{333,  1,  1},{334,  1,  1},{335,  1,  1},{336,  1,  1},{337,  1,  1},{338,  1,  1},{339,  1,  1},{340,  1,  1},{341,  1,  1},{342,  1,  1},{343,  1,  1},{344,  1,  1},{345,  1,  1},{346,  1,  1},{347,  1,  1},{348,  1,  1},{349,  1,  1},{350,  1,  1},{351,  1,  1},{352,  1,  1},{353,  1,  1},{354,  1,  1},{355,  1,  1},{356,  1,  1},{357,  1,  1},{358,  1,  1},{359,  1,  1},{360,  1,  1},{361,  1,  1},{362,  1,  1},{363,  1,  1},{364,  1,  1},{365,  1,  1},{366,  1,  1},{367,  1,  1},{368,  1,  1},{369,  1,  1},{370,  1,  1},{371,  1,  1},{372,  1,  1},{373,  1,  1},{374,  1,  1},{375,  1,  1},{376,  1,  1},{377,  1,  1},{378,  1,  1},{379,  1,  1},{380,  1,  1},{381,  1,  1},{382,  1,  1},{383,  1,  1},{384,  1,  1},{385,  1,  1},{386,  1,  1},{387,  1,  1},{388,  1,  1},{389,  1,  1},{390,  1,  1},{391,  1,  1},{392,  1,  1},{393,  1,  1},{394,  1,  1},{395,  1,  1},{396,  1,  1},{397,  1,  1},{398,  1,  1},{399,  1,  1},{400,  1,  1},{401,  1,  1},{402,  1,  1},{403,  1,  1},{404,  1,  1},{405,  1,  1},{406,  1,  1},{407,  1,  1},{408,  1,  1},{409,  1,  1},{410,  1,  1},{411,  1,  1},{412,  1,  1},{413,  1,  1},{414,  1,  1},{415,  1,  1},{416,  1,  1},{417,  1,  1},{418,  1,  1},{419,  1,  1},{420,  1,  1},{421,  1,  1},{422,  1,  1},{423,  1,  1},{424,  1,  1},{425,  1,  1},{426,  1,  1}};
    test_lwechal_from_gsa(dim, dvol, strategy);

    // printf("============= Dilithium-I\n");
    // int dim =  2049;
    // int dvol = 15614.219317244602;
    // strategy = {}
    // test_lwechal_from_gsa(dim, dvol, strategy);

    // int n = 40;
    // double alpha = 0.025;
    // vector<tuple<int,int,int>> strategy = {{ 79,  8,  1},{ 91,  8,  1},{112,  8,  1}};
    // for(int i = 10; i < 50; i++)
    //     strategy.insert(strategy.end(),{i,1,1});
    // test_lwechal_from_gsa_and_original_instance(n, alpha, strategy);

    // n = 45;
    // alpha = 0.020;
    // strategy = {{ 89,  8,  1},{109,  8,  2}};
    // test_lwechal_from_gsa_and_original_instance(n, alpha, strategy);


    // n = 50;
    // alpha = 0.015;
    // strategy = {{ 89,  8,  1},{107,  8,  2}};
    // test_lwechal_from_gsa_and_original_instance(n, alpha, strategy);


    // // n = 55;
    // // alpha = 0.010;
    // // strategy = {{ 89,  8,  1},{109,  8,  2}};
    // // test_lwechal_from_gsa_and_original_instance(n, alpha, strategy);



    // n = 40;
    // alpha = 0.035;
    // strategy = {{ 83,  8,  1},{ 93,  8,  1},{108,  8,  1},{117,  8,  1},{119,  4,  1},{133,  4,  1}};
    // test_lwechal_from_gsa_and_original_instance(n, alpha, strategy);



    // n = 40;
    // alpha = 0.045;
    // strategy = {{ 79,  8,  1},{ 89,  8,  1},{117,  8,  2},{117,  4,  1},{123,  4,  1},{135,  4,  1},{148,  4,  1},{156,  2,  1}};
    // test_lwechal_from_gsa_and_original_instance(n, alpha, strategy);



}